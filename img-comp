'use client'

import { useState, useRef } from 'react'
import { Upload, Download, X, Maximize2 } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { Slider } from '@/components/ui/slider'

export function ImageCompressor() {
  const [originalImage, setOriginalImage] = useState<File | null>(null)
  const [compressedImage, setCompressedImage] = useState<string | null>(null)
  const [quality, setQuality] = useState(80)
  const [isCompressing, setIsCompressing] = useState(false)
  const [originalSize, setOriginalSize] = useState(0)
  const [compressedSize, setCompressedSize] = useState(0)
  const [fullscreenImage, setFullscreenImage] = useState<string | null>(null)
  const fileInputRef = useRef<HTMLInputElement>(null)
  const originalPreviewRef = useRef<string>('')

  const handleFileSelect = (file: File) => {
    if (file.type.startsWith('image/')) {
      setOriginalImage(file)
      setCompressedImage(null)
      setOriginalSize(file.size)
      setCompressedSize(0)
    }
  }

  const handleDrop = (e: React.DragEvent) => {
    e.preventDefault()
    const file = e.dataTransfer.files[0]
    if (file) handleFileSelect(file)
  }

  const compressImageFile = async () => {
    if (!originalImage) return

    setIsCompressing(true)
    try {
      const reader = new FileReader()
      reader.onload = (e) => {
        const img = new Image()
        img.crossOrigin = 'anonymous'
        img.onload = () => {
          const canvas = document.createElement('canvas')
          canvas.width = img.width
          canvas.height = img.height
          const ctx = canvas.getContext('2d')
          if (ctx) {
            ctx.drawImage(img, 0, 0)
            canvas.toBlob((blob) => {
              if (blob) {
                setCompressedSize(blob.size)
                const url = URL.createObjectURL(blob)
                setCompressedImage(url)
              }
              setIsCompressing(false)
            }, originalImage.type || 'image/jpeg', quality / 100)
          }
        }
        img.src = e.target?.result as string
      }
      reader.readAsDataURL(originalImage)
    } catch {
      setIsCompressing(false)
    }
  }

  const downloadCompressed = () => {
    if (!compressedImage) return
    const link = document.createElement('a')
    link.href = compressedImage
    link.download = `compressed-${originalImage?.name}`
    link.click()
  }

  const reset = () => {
    setOriginalImage(null)
    setCompressedImage(null)
    setQuality(80)
    setOriginalSize(0)
    setCompressedSize(0)
    if (fileInputRef.current) fileInputRef.current.value = ''
  }

  const formatSize = (bytes: number) => {
    if (bytes === 0) return '0 B'
    const k = 1024
    const sizes = ['B', 'KB', 'MB']
    const i = Math.floor(Math.log(bytes) / Math.log(k))
    return Math.round((bytes / Math.pow(k, i)) * 100) / 100 + ' ' + sizes[i]
  }

  const savings = originalSize > 0 ? Math.round(((originalSize - compressedSize) / originalSize) * 100) : 0

  const FullscreenModal = ({ imageSrc, onClose }: { imageSrc: string; onClose: () => void }) => (
    <div className="fixed inset-0 bg-black/90 z-50 flex items-center justify-center p-4" onClick={onClose}>
      <div className="relative max-w-6xl max-h-[90vh]" onClick={(e) => e.stopPropagation()}>
        <button
          onClick={onClose}
          className="absolute top-4 right-4 bg-white/20 hover:bg-white/40 text-white p-2 rounded-full transition-colors"
        >
          <X className="w-6 h-6" />
        </button>
        <img src={imageSrc || "/placeholder.svg"} alt="Fullscreen" className="max-w-full max-h-[85vh] object-contain" />
      </div>
    </div>
  )

  return (
    <div className="w-full max-w-6xl">
      <div className="bg-white dark:bg-slate-900 rounded-2xl shadow-2xl overflow-hidden">
        {/* Upload Section */}
        {!originalImage ? (
          <div
            onDrop={handleDrop}
            onDragOver={(e) => e.preventDefault()}
            className="p-20 text-center cursor-pointer hover:bg-gray-50 dark:hover:bg-slate-800 transition-colors"
          >
            <Upload className="w-24 h-24 mx-auto mb-6 text-blue-500" />
            <p className="text-gray-600 dark:text-gray-400 text-xl mb-6">
              Drag your image here or click to select
            </p>
            <Button
              onClick={() => fileInputRef.current?.click()}
              className="bg-blue-500 hover:bg-blue-600 text-white text-lg px-8 py-6"
            >
              Choose Image
            </Button>
            <input
              ref={fileInputRef}
              type="file"
              accept="image/*"
              onChange={(e) => e.target.files?.[0] && handleFileSelect(e.target.files[0])}
              className="hidden"
            />
          </div>
        ) : (
          <div className="p-12">
            {/* Compression Controls */}
            <div className="mb-12">
              <div className="flex items-center justify-between mb-4">
                <span className="text-sm font-semibold text-gray-700 dark:text-gray-300">Quality</span>
                <span className="text-sm font-semibold text-blue-500">{quality}%</span>
              </div>
              <Slider
                value={[quality]}
                onValueChange={(val) => setQuality(val[0])}
                min={10}
                max={100}
                step={5}
                className="w-full"
              />
            </div>

            <div className="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
              <div>
                <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-3 uppercase">Original</p>
                <div className="relative group">
                  <img
                    src={originalPreviewRef.current || URL.createObjectURL(originalImage)}
                    alt="Original"
                    className="w-full h-96 object-cover rounded-lg bg-gray-100 dark:bg-slate-800"
                    onLoad={(e) => {
                      originalPreviewRef.current = (e.target as HTMLImageElement).src
                    }}
                  />
                  <button
                    onClick={() => setFullscreenImage(originalPreviewRef.current)}
                    className="absolute top-3 right-3 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
                  >
                    <Maximize2 className="w-5 h-5" />
                  </button>
                </div>
                <p className="text-xs text-gray-500 dark:text-gray-400 mt-3">{formatSize(originalSize)}</p>
              </div>
              {compressedImage && (
                <div>
                  <p className="text-xs font-semibold text-gray-600 dark:text-gray-400 mb-3 uppercase">Compressed</p>
                  <div className="relative group">
                    <img
                      src={compressedImage || "/placeholder.svg"}
                      alt="Compressed"
                      className="w-full h-96 object-cover rounded-lg bg-gray-100 dark:bg-slate-800"
                    />
                    <button
                      onClick={() => setFullscreenImage(compressedImage)}
                      className="absolute top-3 right-3 bg-black/50 hover:bg-black/70 text-white p-2 rounded-lg opacity-0 group-hover:opacity-100 transition-opacity"
                    >
                      <Maximize2 className="w-5 h-5" />
                    </button>
                  </div>
                  <p className="text-xs text-gray-500 dark:text-gray-400 mt-3">
                    {formatSize(compressedSize)} {savings > 0 && <span className="text-green-500">(-{savings}%)</span>}
                  </p>
                </div>
              )}
            </div>

            {/* Action Buttons */}
            <div className="flex gap-3">
              {!compressedImage ? (
                <Button
                  onClick={compressImageFile}
                  disabled={isCompressing}
                  className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-6 text-base"
                >
                  {isCompressing ? 'Compressing...' : 'Compress'}
                </Button>
              ) : (
                <>
                  <Button
                    onClick={downloadCompressed}
                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-6 text-base flex items-center justify-center gap-2"
                  >
                    <Download className="w-5 h-5" />
                    Download
                  </Button>
                  <Button
                    onClick={reset}
                    variant="outline"
                    className="py-6 px-6 flex items-center justify-center gap-2"
                  >
                    <X className="w-5 h-5" />
                  </Button>
                </>
              )}
            </div>
          </div>
        )}
      </div>

      {fullscreenImage && (
        <FullscreenModal imageSrc={fullscreenImage} onClose={() => setFullscreenImage(null)} />
      )}
    </div>
  )
}
